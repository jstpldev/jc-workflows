# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Maven CI

on:  
  workflow_call:
    secrets:
        SCM_MAVEN_IP:
          required: true
        SCM_MAVEN_USER:
          required: true
        SCM_MAVEN_PW:
          required: true
          
jobs:
  maven-ci:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    name: Maven CI
    continue-on-error: false
    env:
      # JFrog platform url (for example: https://acme.jfrog.io)
      JF_URL: "http://${{ secrets.SCM_MAVEN_IP }}"
      # Basic authentication credentials
      JF_USER: ${{ secrets.SCM_MAVEN_USER }}
      JF_PASSWORD: ${{ secrets.SCM_MAVEN_PW }}
      SERVER_WEBSITE_USER: ${{ secrets.SERVER_WEBSITE_USER }}
      SERVER_WEBSITE_PASSWORD: ${{ secrets.SERVER_WEBSITE_PASSWORD }}
      SERVER_MAVEN_REPO_USER: ${{ secrets.SERVER_MAVEN_REPO_USER }}
      SERVER_MAVEN_REPO_PASSWORD: ${{ secrets.SERVER_MAVEN_REPO_PASSWORD }}
      SERVER_SONATYPE_NEXUS_SNAPSHOTS_USER: ${{ secrets.SERVER_SONATYPE_NEXUS_SNAPSHOTS_USER }}
      SERVER_SONATYPE_NEXUS_SNAPSHOTS_PASSWORD: ${{ secrets.SERVER_SONATYPE_NEXUS_SNAPSHOTS_PASSWORD }}
      SERVER_SONATYPE_NEXUS_STAGING_USER: ${{ secrets.SERVER_SONATYPE_NEXUS_STAGING_USER }}
      SERVER_SONATYPE_NEXUS_STAGING_PASSWORD: ${{ secrets.SERVER_SONATYPE_NEXUS_STAGING_PASSWORD }}
      SERVER_SCM_USER: ${{ secrets.SERVER_SCM_USER }}
      SERVER_SCM_PASSWORD: ${{ secrets.SERVER_SCM_PASSWORD }}
      SERVER_BUILD_REPO_USER: ${{ secrets.SERVER_BUILD_REPO_USER }}
      SERVER_BUILD_REPO_PASSWORD: ${{ secrets.SERVER_BUILD_REPO_PASSWORD }}
      ARTIFACTORY_REPO_URL: ${{ secrets.ARTIFACTORY_REPO_URL }}
      SERVER_SCM_ID: ${{ secrets.SERVER_SCM_ID }}
    steps:
    - name: Checkout build repo
      uses: actions/checkout@v3
      
    - name: Extract owner
      shell: bash
      run: echo "##[set-output name=owner;]$(echo ${GITHUB_REPOSITORY%/*})"
      id: extract_owner
      
    - name: Checkout common workflows repo
      uses: actions/checkout@v3
      with:
        repository: ${{ steps.extract_owner.outputs.owner }}/jc-workflows
        ref: main
        path: jc-workflows
        
    - uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '7'
        cache: 'maven'
    
    - name: Set up maven
      uses: stCarolas/setup-maven@v4.4
      with:
          maven-version: 3.6.3
                
    - name: Copy settings.xml
      run: |
        cp jc-workflows/conf/settings.xml ~/.m2/settings.xml
      
    - name: Build with Maven
      run: |
       mvn clean install
       
    - name: Get project version env variable
      run: |
        mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version -o | grep -v '\['
        echo "PROJECT_VERSION=$(mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version -o | grep -v '\[')" >> $GITHUB_ENV
               
    - name: Publish
      run: | 
        echo "PROJECT_VERSION=$PROJECT_VERSION"
        mvn deploy -DaltDeploymentRepository=snapshots::default::${JF_URL}/artifactory/libs-snapshot -DaltSnapshotDeploymentRepository=snapshots::default::${JF_URL}/artifactory/libs-snapshot -DaltReleaseDeploymentRepository=releases::default::${JF_URL}/artifactory/libs-release
